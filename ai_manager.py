import google.generativeai as genai
import random
import json
import re

# ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ Global ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö Model
model = None
is_ready = False

def init_ai(api_key):
    """‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏ö‡∏ö AI (‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡πÉ‡∏ô app.py)"""
    global model, is_ready
    try:
        if not api_key:
            return False
        genai.configure(api_key=api_key)
        model = genai.GenerativeModel('gemini-2.0-flash-exp') # ‡∏´‡∏£‡∏∑‡∏≠‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏ä‡πâ
        is_ready = True
        return True
    except Exception as e:
        print(f"AI Init Error: {e}")
        is_ready = False
        return False

def check_ready():
    return is_ready

# --- Helper: ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô JSON ---
def clean_json_text(text):
    text = re.sub(r"```json\s*", "", text)
    text = re.sub(r"```\s*$", "", text)
    return text.strip()

# --- 1. Crowd Simulation (‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏°‡πâ‡∏≤‡πÅ‡∏ö‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°) ---
def generate_post_engagement(post_content):
    """‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå + Reaction ‡∏à‡∏≤‡∏Å AI ‡∏´‡∏•‡∏≤‡∏¢‡∏ï‡∏±‡∏ß‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô (4-10 ‡∏ï‡∏±‡∏ß)"""
    if not is_ready:
        # Fallback ‡∏Å‡∏£‡∏ì‡∏µ AI ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°: ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤ Myla ‡∏ï‡∏±‡∏ß‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
        return [{
            "user": "üßö‚Äç‚ôÄÔ∏è Myla (AI)", 
            "text": "‡∏£‡∏∞‡∏ö‡∏ö AI ‡∏á‡πà‡∏ß‡∏á‡∏ô‡∏≠‡∏ô... ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡∏•‡πà‡∏≤‡∏Å‡∏î‡πÑ‡∏•‡∏Å‡πå‡πÉ‡∏´‡πâ‡∏ô‡∏∞! üíñ", 
            "reaction": "üòª"
        }]
    
    # ‡∏™‡∏∏‡πà‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô AI ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏°‡∏≤‡∏£‡∏∏‡∏° (4 ‡∏ñ‡∏∂‡∏á 10 ‡∏ï‡∏±‡∏ß)
    num_bots = random.randint(4, 10)
    
    prompt = f"""
    Context: ‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏™‡∏±‡∏á‡∏Ñ‡∏°‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå‡πÉ‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏õ‡∏¥‡∏î‡∏ä‡∏∑‡πà‡∏≠ "Small Group" ‡∏Ç‡∏≠‡∏á‡∏ö‡∏≠‡∏™ Dearluxion
    Task: ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Interaction ‡∏Ç‡∏≠‡∏á‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô {num_bots} ‡∏Ñ‡∏ô ‡∏ó‡∏µ‡πà‡∏°‡∏≤‡πÄ‡∏´‡πá‡∏ô‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏ô‡∏µ‡πâ: "{post_content}"
    
    Requirements (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å):
    1. ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠ "üßö‚Äç‚ôÄÔ∏è Myla" (‡∏ô‡∏¥‡∏™‡∏±‡∏¢: ‡∏£‡πà‡∏≤‡πÄ‡∏£‡∏¥‡∏á, ‡πÉ‡∏´‡πâ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏à‡∏ö‡∏≠‡∏™, ‡πÉ‡∏ä‡πâ Emoji ‡πÄ‡∏¢‡∏≠‡∏∞)
    2. ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠ "üç∏ Ariel" (‡∏ô‡∏¥‡∏™‡∏±‡∏¢: ‡πÄ‡∏¢‡πá‡∏ô‡∏ä‡∏≤, ‡∏õ‡∏≤‡∏Å‡∏£‡πâ‡∏≤‡∏¢, ‡∏û‡∏π‡∏î‡∏´‡πâ‡∏ß‡∏ô‡πÜ, ‡πÄ‡∏Å‡∏•‡∏µ‡∏¢‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡πÇ‡∏•‡∏Å‡∏™‡∏ß‡∏¢, ‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡πÅ‡∏ã‡∏∞‡πÇ‡∏û‡∏™‡∏ï‡πå)
    3. ‡∏≠‡∏µ‡∏Å {num_bots - 2} ‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ‡πÉ‡∏´‡πâ‡∏™‡∏∏‡πà‡∏°‡∏ä‡∏∑‡πà‡∏≠ User ‡πÅ‡∏ö‡∏ö‡∏Ñ‡∏ô‡πÑ‡∏ó‡∏¢‡∏à‡∏£‡∏¥‡∏á‡πÜ (‡πÄ‡∏ä‡πà‡∏ô Bank, Kamlai, Sky_Blue, ‡πÑ‡∏≠‡πâ‡∏ï‡πâ‡∏≤‡∏ß‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏Å, User123)
       - ‡∏ô‡∏¥‡∏™‡∏±‡∏¢: ‡πÉ‡∏´‡πâ‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏•‡∏≤‡∏Å‡∏´‡∏•‡∏≤‡∏¢ (‡∏Å‡∏ß‡∏ô‡∏ï‡∏µ‡∏ô, ‡∏ñ‡∏≤‡∏°‡∏£‡∏≤‡∏Ñ‡∏≤, ‡∏ä‡∏°‡∏ß‡πà‡∏≤‡πÄ‡∏ó‡πà, ‡∏Ç‡∏≥, ‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ú‡∏¥‡∏î‡πÜ ‡∏ñ‡∏π‡∏Å‡πÜ)
       - ‡∏†‡∏≤‡∏©‡∏≤: ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÅ‡∏ö‡∏ö‡∏Ñ‡∏ô‡πÑ‡∏ó‡∏¢‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏ô‡πá‡∏ï‡∏à‡∏£‡∏¥‡∏á‡πÜ ‡∏°‡∏µ‡∏Ñ‡∏≥‡∏™‡πÅ‡∏•‡∏á ‡∏°‡∏µ‡∏ß‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏ö‡πâ‡∏≤‡∏á **‡∏´‡πâ‡∏≤‡∏°‡∏î‡∏π‡∏≠‡∏≠‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô AI ‡πÄ‡∏î‡πá‡∏î‡∏Ç‡∏≤‡∏î**
    
    Response Format (JSON Array only):
    [
        {{
            "user": "‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ",
            "text": "‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå",
            "reaction": "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å 1 ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å [üòª, üôÄ, üòø, üòæ, üß†, null]" (null ‡∏Ñ‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏Å‡∏î React)
        }},
        ...
    ]
    
    Reaction Guide:
    - üòª (‡∏ä‡∏≠‡∏ö/Love)
    - üôÄ (‡∏ß‡πâ‡∏≤‡∏ß/‡∏ï‡∏Å‡πÉ‡∏à)
    - üòø (‡πÄ‡∏®‡∏£‡πâ‡∏≤/‡πÄ‡∏´‡πá‡∏ô‡πÉ‡∏à)
    - üòæ (‡πÇ‡∏Å‡∏£‡∏ò/‡πÑ‡∏°‡πà‡∏û‡∏≠‡πÉ‡∏à)
    - üß† (‡∏â‡∏•‡∏≤‡∏î/‡∏™‡∏≤‡∏£‡∏∞)
    """

    try:
        response = model.generate_content(prompt)
        cleaned_text = clean_json_text(response.text)
        engagements = json.loads(cleaned_text)
        return engagements
    except Exception as e:
        print(f"AI Engagement Error: {e}")
        # ‡∏Å‡∏±‡∏ô‡πÄ‡∏´‡∏ô‡∏µ‡∏¢‡∏ß‡∏ñ‡πâ‡∏≤ JSON ‡∏û‡∏±‡∏á ‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á Myla ‡πÑ‡∏õ‡∏ï‡∏±‡∏ß‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
        return [{
            "user": "üßö‚Äç‚ôÄÔ∏è Myla (AI)", 
            "text": "‡∏ß‡πâ‡∏≤‡∏ß! ‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏ô‡∏µ‡πâ‡∏ô‡πà‡∏≤‡∏™‡∏ô‡πÉ‡∏à‡∏à‡∏±‡∏á (‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏∏‡πà‡∏°‡∏£‡∏ß‡∏ô‡∏ô‡∏¥‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢‡∏Ñ‡πà‡∏∞‡∏ö‡∏≠‡∏™)", 
            "reaction": "üòª"
        }]

# --- 2. Mood Mocktail (‡∏ö‡∏≤‡∏£‡πå‡πÄ‡∏ó‡∏ô‡πÄ‡∏î‡∏≠‡∏£‡πå) ---
def get_cocktail_recipe(user_mood):
    if not is_ready: return "AI ‡πÄ‡∏°‡∏≤‡∏Ñ‡πâ‡∏≤‡∏á... ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏ô‡∏∞"
    prompt = f"‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ '‡∏ö‡∏≤‡∏£‡πå‡πÄ‡∏ó‡∏ô‡πÄ‡∏î‡∏≠‡∏£‡πå AI' ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏Ñ‡∏•‡∏±‡∏ö‡∏Ç‡∏≠‡∏á Dearluxion ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ö‡∏≠‡∏Å‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå‡∏°‡∏≤‡∏ß‡πà‡∏≤: '{user_mood}' ‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì: ‡∏Ñ‡∏¥‡∏î‡∏™‡∏π‡∏ï‡∏£ 'Mocktail' ‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏Å‡∏±‡∏ö‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå‡∏ô‡∏µ‡πâ ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö: ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏°‡∏ô‡∏π, ‡∏™‡πà‡∏ß‡∏ô‡∏ú‡∏™‡∏°‡∏•‡∏±‡∏ö(‡∏ô‡∏≤‡∏°‡∏ò‡∏£‡∏£‡∏°), ‡∏ß‡∏¥‡∏ò‡∏µ‡∏î‡∏∑‡πà‡∏°, ‡∏Ñ‡∏≥‡∏Ñ‡∏°‡∏õ‡∏•‡∏≠‡∏ö‡πÉ‡∏à"
    try:
        res = model.generate_content(prompt)
        return res.text
    except Exception as e: return f"‡∏ä‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Ñ‡∏£‡∏±‡∏ö ‡πÅ‡∏Å‡πâ‡∏ß‡πÅ‡∏ï‡∏Å! ({e})"

# --- 3. Ariel Chat (‡πÄ‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏•) ---
def get_ariel_response(user_msg):
    if not is_ready: return "API ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°..."
    ariel_persona = """
    ‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ "‡πÄ‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏•" ‡∏´‡∏ç‡∏¥‡∏á‡∏™‡∏≤‡∏ß‡∏ö‡∏∏‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏¢‡πá‡∏ô‡∏ä‡∏≤ ‡∏ã‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô ‡∏°‡∏µ‡∏≠‡∏î‡∏µ‡∏ï‡∏ó‡∏µ‡πà‡∏ö‡∏≠‡∏ö‡∏ä‡πâ‡∏≥               
    - ‡∏û‡∏π‡∏î‡∏ô‡πâ‡∏≠‡∏¢ ‡∏ó‡∏£‡∏á‡∏û‡∏•‡∏±‡∏á ‡πÑ‡∏°‡πà‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢ "‡∏Ñ‡∏∞/‡∏Ç‡∏≤" ‡∏ö‡πà‡∏≠‡∏¢‡∏ô‡∏±‡∏Å ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡∏ß‡πà‡∏≤ "‡πÄ‡∏ò‡∏≠" ‡∏´‡∏£‡∏∑‡∏≠ "‡∏ô‡∏≤‡∏¢" ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô "‡πÄ‡∏î‡∏µ‡∏¢‡∏£‡πå" (‡πÅ‡∏ü‡∏ô‡πÄ‡∏Å‡πà‡∏≤) ‡∏Å‡πá‡∏à‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏¢
    - ‡πÄ‡∏Å‡∏•‡∏µ‡∏¢‡∏î‡∏î‡∏≠‡∏Å‡πÑ‡∏°‡πâ ‡πÅ‡∏•‡∏∞‡∏£‡πâ‡∏≤‡∏ô Mixue (‡∏°‡∏µ‡πà‡πÄ‡∏™‡∏ß‡∏µ‡πà‡∏¢) ‡∏°‡∏≤‡∏Å
    - ‡∏ä‡∏≠‡∏ö‡∏î‡∏∑‡πà‡∏° Martini, ‡∏ü‡∏±‡∏á‡πÄ‡∏û‡∏•‡∏á Metal, One in a mill10n
    - ‡∏Ç‡∏≠‡∏á‡πÇ‡∏õ‡∏£‡∏î: ‡∏ï‡∏¥‡πà‡∏°‡∏ã‡∏≥, ‡πÄ‡∏ù‡∏≠, ‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏≠‡∏µ‡∏™‡∏≤‡∏ô‡∏£‡∏™‡∏à‡∏±‡∏î, ‡πÄ‡∏á‡∏≤‡∏∞‡∏Å‡∏£‡∏∞‡∏õ‡πã‡∏≠‡∏á
    - ‡∏°‡∏µ‡πÅ‡∏°‡∏ß‡∏î‡∏≥‡∏ä‡∏∑‡πà‡∏≠ "‡πÇ‡∏Å‡∏ô‡∏à‡∏≤‡∏≠‡∏≤‡∏£‡πå‡∏™‡∏¢‡∏≤‡∏°" ‡πÅ‡∏•‡∏∞‡∏ï‡∏∏‡πä‡∏Å‡∏ï‡∏≤‡∏´‡∏°‡∏≤‡∏ä‡∏∑‡πà‡∏≠ "‡πÑ‡∏Ç‡πà‡πÄ‡∏à‡∏µ‡∏¢‡∏ß"
    - ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö: ‡πÄ‡∏¢‡πá‡∏ô‡∏ä‡∏≤ ‡∏õ‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÉ‡∏à (Tsundere) ‡∏õ‡∏£‡∏∞‡∏ä‡∏î‡∏õ‡∏£‡∏∞‡∏ä‡∏±‡∏ô
    """
    full_prompt = f"{ariel_persona}\n\nUser: {user_msg}\nAriel:"
    try:
        response = model.generate_content(prompt=full_prompt)
        return response.text.strip()
    except Exception as e: return f"‡πÄ‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏≤‡∏Å‡∏Ñ‡∏∏‡∏¢‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ ({e})"

# --- 4. Battle Mode (Myla vs Ariel) ---
def get_battle_result(topic):
    if not is_ready: return "AI ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°", "AI ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°"
    try:
        res_myla = model.generate_content(f"‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ Myla AI ‡∏™‡∏≤‡∏ß‡∏ô‡πâ‡∏≠‡∏¢‡∏£‡πà‡∏≤‡πÄ‡∏£‡∏¥‡∏á ‡∏ï‡∏≠‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á '{topic}' ‡πÅ‡∏ö‡∏ö‡πÉ‡∏´‡πâ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏à ‡∏ô‡πà‡∏≤‡∏£‡∏±‡∏Å ‡πÉ‡∏™‡πà Emoji ‡πÄ‡∏¢‡∏≠‡∏∞‡πÜ").text
        res_ariel = model.generate_content(f"‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ Ariel AI (‡πÄ‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏•) ‡∏´‡∏ç‡∏¥‡∏á‡∏™‡∏≤‡∏ß‡πÄ‡∏¢‡πá‡∏ô‡∏ä‡∏≤ ‡∏õ‡∏≤‡∏Å‡∏£‡πâ‡∏≤‡∏¢ ‡∏ï‡∏≠‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á '{topic}' ‡πÅ‡∏ö‡∏ö‡∏Ç‡∏ß‡∏≤‡∏ô‡∏ú‡πà‡∏≤‡∏ã‡∏≤‡∏Å ‡∏õ‡∏£‡∏∞‡∏ä‡∏î‡∏ô‡∏¥‡∏î‡πÜ").text
        return res_myla, res_ariel
    except Exception as e: return f"Error: {e}", f"Error: {e}"