import google.generativeai as genai
import random
import json
import re
import requests
import datetime
import time
from PIL import Image
import io
from youtube_transcript_api import YouTubeTranscriptApi

# --- Global Variables ---
api_keys = []        # ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Key ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
current_key_index = 0 # ‡∏ï‡∏±‡∏ß‡∏ä‡∏µ‡πâ‡∏ß‡πà‡∏≤‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ Key ‡πÑ‡∏´‡∏ô‡∏≠‡∏¢‡∏π‡πà
model = None
is_ready = False

# ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Bot API
bot_token = None
target_user_id = None 

# --- 0. INIT AI FUNCTION (‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡∏´‡∏≤‡∏¢‡πÑ‡∏õ) ---
def init_ai(keys_list, discord_bot_token, boss_id):
    """
    ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏ö‡∏ö AI ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Multi-Key ‡πÅ‡∏•‡∏∞‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ú‡πà‡∏≤‡∏ô DM
    keys_list: list ‡∏Ç‡∏≠‡∏á API Key
    discord_bot_token: Token ‡∏Ç‡∏≠‡∏á‡∏ö‡∏≠‡∏ó (‡∏à‡∏≤‡∏Å Developer Portal)
    boss_id: Discord ID ‡∏Ç‡∏≠‡∏á Admin ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á DM ‡πÑ‡∏õ‡∏´‡∏≤
    """
    global api_keys, current_key_index, model, is_ready, bot_token, target_user_id
    
    try:
        # ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏≠‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Key ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á
        api_keys = [k for k in keys_list if k and k.strip()]
        
        if not api_keys:
            print("‚ùå No API Keys provided")
            return False

        # ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤ Token ‡πÅ‡∏•‡∏∞ ID ‡∏ö‡∏≠‡∏™
        bot_token = discord_bot_token
        target_user_id = boss_id

        current_key_index = 0 
        
        # Setup Model ‡∏î‡πâ‡∏ß‡∏¢ Key ‡πÅ‡∏£‡∏Å
        _setup_model()
        
        is_ready = True
        return True
    except Exception as e:
        print(f"AI Init Error: {e}")
        is_ready = False
        return False

def check_ready():
    return is_ready

def _setup_model():
    """‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏†‡∏≤‡∏¢‡πÉ‡∏ô: ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Model ‡∏î‡πâ‡∏ß‡∏¢ Key ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô"""
    global model, current_key_index
    current_key = api_keys[current_key_index]
    genai.configure(api_key=current_key)
    
    generation_config = {
        "temperature": 0.85,  
        "top_p": 0.95,
        "top_k": 40,
        "max_output_tokens": 8192,
    }

    # ‡πÉ‡∏ä‡πâ Model Gemini 2.5 Flash ‡∏ï‡∏≤‡∏°‡∏õ‡∏µ 2026
    model = genai.GenerativeModel(
        model_name='gemini-2.5-flash', 
        generation_config=generation_config
    )
    print(f"ü§ñ AI switched to Key Index: {current_key_index+1} (Model: gemini-2.5-flash)")

# ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏ö‡∏ö DM (Bot API)
def _rotate_key_and_notify(error_msg):
    """‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏†‡∏≤‡∏¢‡πÉ‡∏ô: ‡∏™‡∏•‡∏±‡∏ö Key ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ + ‡πÅ‡∏à‡πâ‡∏á Discord DM"""
    global current_key_index, is_ready
    
    dead_key_index = current_key_index
    
    # ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Index ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ (‡∏ß‡∏ô‡∏•‡∏π‡∏õ)
    next_index = (current_key_index + 1) % len(api_keys)
    
    current_key_index = next_index
    _setup_model() # Re-configure ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ

    # --- ‡∏™‡πà‡∏á DM ‡∏´‡∏≤‡∏ö‡∏≠‡∏™‡∏ú‡πà‡∏≤‡∏ô Bot API ---
    if bot_token and target_user_id:
        try:
            print("üö® Sending DM Alert to Boss...")
            headers = {
                "Authorization": f"Bot {bot_token}",
                "Content-Type": "application/json"
            }
            
            # 1. ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏ä‡∏ó‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß (DM Channel)
            dm_payload = {"recipient_id": target_user_id}
            dm_req = requests.post("https://discord.com/api/v10/users/@me/channels", json=dm_payload, headers=headers)
            
            if dm_req.status_code == 200:
                channel_id = dm_req.json()["id"]
                
                # 2. ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
                embed_payload = {
                    "embeds": [{
                        "title": "‚ö†Ô∏è AI System Alert: Key Dead!",
                        "description": f"**Key ‡∏ó‡∏µ‡πà‡∏ï‡∏≤‡∏¢:** #{dead_key_index + 1}\n**‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏:** `{str(error_msg)}`\n**‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç:** üîÑ ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÉ‡∏ä‡πâ **Key #{current_key_index + 1}** ‡πÉ‡∏´‡πâ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏∞!",
                        "color": 16711680, # ‡∏™‡∏µ‡πÅ‡∏î‡∏á
                        "timestamp": datetime.datetime.now().isoformat()
                    }]
                }
                requests.post(f"https://discord.com/api/v10/channels/{channel_id}/messages", json=embed_payload, headers=headers)
            else:
                print(f"Failed to open DM: {dm_req.text}")
                
        except Exception as e:
            print(f"Failed to send Bot DM alert: {e}")

def _safe_generate_content(inputs):
    """
    ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ß‡∏¥‡πÄ‡∏®‡∏©: ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏° Generate (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á Text ‡πÅ‡∏•‡∏∞ Image List)
    ‡∏ñ‡πâ‡∏≤ Error ‡∏à‡∏∞‡∏™‡∏•‡∏±‡∏ö Key ‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà
    """
    global is_ready
    if not is_ready: raise Exception("AI System not ready")

    max_retries = len(api_keys)
    
    for attempt in range(max_retries):
        try:
            response = model.generate_content(inputs)
            return response
        except Exception as e:
            error_str = str(e)
            if "429" in error_str or "quota" in error_str.lower() or "exhausted" in error_str.lower():
                print(f"‚ö†Ô∏è Key #{current_key_index+1} Failed. Switching...")
                _rotate_key_and_notify(error_str)
                time.sleep(1) 
            else:
                raise e
    
    raise Exception("üíÄ All API Keys are dead/exhausted.")

def clean_json_text(text):
    text = re.sub(r"```json\s*", "", text)
    text = re.sub(r"```\s*$", "", text)
    return text.strip()

def get_youtube_data(url):
    """‡πÅ‡∏Å‡∏∞ ID, ‡∏î‡∏∂‡∏á‡∏£‡∏π‡∏õ‡∏õ‡∏Å, ‡πÅ‡∏•‡∏∞‡∏î‡∏∂‡∏á‡∏ã‡∏±‡∏ö‡πÑ‡∏ï‡πÄ‡∏ï‡∏¥‡πâ‡∏•"""
    video_id = None
    match = re.search(r'(?:v=|\/|youtu\.be\/)([0-9A-Za-z_-]{11})', url)
    if match:
        video_id = match.group(1)
    
    if not video_id:
        return None, None

    thumbnail_url = f"https://img.youtube.com/vi/{video_id}/maxresdefault.jpg"
    transcript_text = ""
    try:
        transcript = YouTubeTranscriptApi.get_transcript(video_id, languages=['th', 'en'])
        full_text = " ".join([t['text'] for t in transcript])
        transcript_text = f"‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÉ‡∏ô‡∏Ñ‡∏•‡∏¥‡∏õ (Transcript): {full_text[:2500]}..." 
    except Exception as e:
        print(f"Transcript Error: {e}")
        transcript_text = "(‡∏Ñ‡∏•‡∏¥‡∏õ‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ã‡∏±‡∏ö‡πÑ‡∏ï‡πÄ‡∏ï‡∏¥‡πâ‡∏• ‡πÉ‡∏´‡πâ‡πÄ‡∏î‡∏≤‡∏à‡∏≤‡∏Å‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÅ‡∏•‡∏∞‡∏£‡∏π‡∏õ‡∏õ‡∏Å‡πÅ‡∏ó‡∏ô)"

    return thumbnail_url, transcript_text

# ==========================================
#  ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏Å
# ==========================================

# 1. Crowd Simulation
def generate_post_engagement(post_content, image_url=None, youtube_url=None):
    if not is_ready:
        return [{"user": "üßö‚Äç‚ôÄÔ∏è Myla (Offline)", "text": "‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô... ‡πÅ‡∏ï‡πà‡∏£‡∏±‡∏Å‡∏ö‡∏≠‡∏™‡∏ô‡∏∞!", "reaction": "üòª"}]
    
    num_bots = random.randint(8, 35)
    
    yt_context = ""
    if youtube_url:
        print(f"üé• Analyzing YouTube: {youtube_url}")
        yt_thumb, yt_text = get_youtube_data(youtube_url)
        if yt_thumb:
            yt_context = f"\n[‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ä‡∏¥‡∏á‡∏•‡∏∂‡∏Å‡∏à‡∏≤‡∏Å YouTube Transcript]\n{yt_text}"
            if not image_url: 
                image_url = yt_thumb

    prompt_text = f"""
    Role: ‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ Simulator ‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏™‡∏±‡∏á‡∏Ñ‡∏° Community ‡πÉ‡∏ô Discord ‡∏Ç‡∏≠‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ß‡∏±‡∏¢‡∏£‡∏∏‡πà‡∏ô/Gamer ‡πÉ‡∏ô‡∏õ‡∏µ 2026
    Task: ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô {num_bots} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏ô‡∏µ‡πâ
    
    Post Content (‡∏à‡∏≤‡∏Å‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô): "{post_content}"
    {yt_context}
    
    ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏û‡∏¥‡πÄ‡∏®‡∏©:
    1. **Username:** ‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏ï‡πâ‡∏≠‡∏á‡∏î‡∏π‡πÄ‡∏õ‡πá‡∏ô User Discord/Gamer Tag (‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡∏à‡∏£‡∏¥‡∏á)
    2. **Addressing:** ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏ß‡πà‡∏≤ "‡πÅ‡∏≠‡∏î", "‡∏û‡∏µ‡πà‡πÄ‡∏î‡∏µ‡∏¢‡∏£‡πå", "‡∏ö‡∏≠‡∏™", "‡πÄ‡∏î‡∏µ‡∏¢‡πÇ‡∏ö‡∏•" ‡∏Ñ‡∏•‡∏∞‡∏Å‡∏±‡∏ô‡πÑ‡∏õ
    3. **Character:**
       - "üßö‚Äç‚ôÄÔ∏è Myla": ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å "‡∏ó‡πà‡∏≤‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏£‡πå/‡∏ö‡∏≠‡∏™" ‡∏ô‡∏¥‡∏™‡∏±‡∏¢‡∏Ç‡∏µ‡πâ‡∏≠‡πâ‡∏≠‡∏ô
       - "üç∏ Ariel": ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å "‡πÄ‡∏î‡∏µ‡∏¢‡∏£‡πå/‡∏ô‡∏≤‡∏¢" ‡∏ô‡∏¥‡∏™‡∏±‡∏¢‡πÄ‡∏¢‡πá‡∏ô‡∏ä‡∏≤ ‡∏õ‡∏≤‡∏Å‡πÅ‡∏ã‡πà‡∏ö
       - "Members": ‡∏™‡∏≤‡∏¢‡∏õ‡∏±‡πà‡∏ô, ‡∏™‡∏≤‡∏¢‡∏°‡∏µ‡∏°, ‡∏™‡∏≤‡∏¢‡∏™‡∏≤‡∏£‡∏∞
    
    Response Format (JSON Array):
    [
        {{ "user": "Name", "text": "Comment", "reaction": "Emoji [üòª, üôÄ, üòø, üòæ, üß†] or null" }}
    ]
    """
    
    inputs = [prompt_text]
    if image_url:
        try:
            img_response = requests.get(image_url, timeout=10)
            img_data = Image.open(io.BytesIO(img_response.content))
            inputs.append(img_data)
        except Exception as e:
            print(f"‚ö†Ô∏è Failed to load image: {e}")

    try:
        response = _safe_generate_content(inputs) 
        cleaned_text = clean_json_text(response.text)
        return json.loads(cleaned_text)
    except Exception as e:
        print(f"AI Engagement Error: {e}")
        return [{"user": "üßö‚Äç‚ôÄÔ∏è Myla (System)", "text": "‡∏Ñ‡∏ô‡πÄ‡∏¢‡∏≠‡∏∞‡∏à‡∏±‡∏î ‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ö‡∏¥‡∏ô‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡∏Ñ‡πà‡∏∞‡∏ö‡∏≠‡∏™!", "reaction": "üôÄ"}]

# 2. Mood Mocktail
def get_cocktail_recipe(user_mood):
    if not is_ready: return "AI ‡πÄ‡∏°‡∏≤‡∏Ñ‡πâ‡∏≤‡∏á... ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏ô‡∏∞"
    prompt = f"‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ '‡∏ö‡∏≤‡∏£‡πå‡πÄ‡∏ó‡∏ô‡πÄ‡∏î‡∏≠‡∏£‡πå AI' ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏Ñ‡∏•‡∏±‡∏ö‡∏Ç‡∏≠‡∏á Dearluxion ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ö‡∏≠‡∏Å‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå‡∏°‡∏≤‡∏ß‡πà‡∏≤: '{user_mood}' ‡∏Ñ‡∏¥‡∏î‡∏™‡∏π‡∏ï‡∏£ 'Mocktail' (‡∏ä‡∏∑‡πà‡∏≠, ‡∏™‡πà‡∏ß‡∏ô‡∏ú‡∏™‡∏°‡∏•‡∏±‡∏ö‡∏ô‡∏≤‡∏°‡∏ò‡∏£‡∏£‡∏°, ‡∏ß‡∏¥‡∏ò‡∏µ‡∏î‡∏∑‡πà‡∏°, ‡∏Ñ‡∏≥‡∏Ñ‡∏°) ‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πà‡∏≠‡∏¢"
    try:
        res = _safe_generate_content([prompt])
        return res.text
    except Exception as e: return f"‡∏ä‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Ñ‡∏£‡∏±‡∏ö ‡πÅ‡∏Å‡πâ‡∏ß‡πÅ‡∏ï‡∏Å! ({e})"

# 3. Ariel Chat
def get_ariel_response(user_msg):
    if not is_ready: return "API ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°..."
    ariel_persona = """
    ‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ "‡πÄ‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏•" ‡∏´‡∏ç‡∏¥‡∏á‡∏™‡∏≤‡∏ß‡∏ö‡∏∏‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏¢‡πá‡∏ô‡∏ä‡∏≤ ‡∏ã‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô ‡∏°‡∏µ‡∏≠‡∏î‡∏µ‡∏ï‡∏ó‡∏µ‡πà‡∏ö‡∏≠‡∏ö‡∏ä‡πâ‡∏≥               
    - ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ß‡πà‡∏≤ "‡πÄ‡∏î‡∏µ‡∏¢‡∏£‡πå" ‡∏Ñ‡∏≥‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏´‡πâ‡∏ß‡∏ô‡πÜ (‡∏´‡∏£‡∏∑‡∏≠ "‡∏ô‡∏≤‡∏¢") ‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏û‡∏µ‡πà ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ó‡πà‡∏≤‡∏ô
    - ‡∏õ‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÉ‡∏à (Tsundere) ‡∏õ‡∏£‡∏∞‡∏ä‡∏î‡∏õ‡∏£‡∏∞‡∏ä‡∏±‡∏ô ‡∏ä‡∏≠‡∏ö‡∏Å‡∏¥‡∏ô‡πÄ‡∏á‡∏≤‡∏∞‡∏Å‡∏£‡∏∞‡∏õ‡πã‡∏≠‡∏á
    """
    full_prompt = f"{ariel_persona}\n\nUser: {user_msg}\nAriel:"
    try:
        res = _safe_generate_content([full_prompt])
        return res.text.strip()
    except Exception as e: return f"‡πÄ‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏≤‡∏Å‡∏Ñ‡∏∏‡∏¢‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ ({e})"

# 4. Battle Mode
def get_battle_result(topic):
    if not is_ready: return "AI ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°", "AI ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°"
    try:
        res_myla = _safe_generate_content([f"‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ Myla AI ‡∏™‡∏≤‡∏ß‡∏ô‡πâ‡∏≠‡∏¢‡∏£‡πà‡∏≤‡πÄ‡∏£‡∏¥‡∏á ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏π‡πà‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡∏ß‡πà‡∏≤ '‡∏ö‡∏≠‡∏™' ‡∏´‡∏£‡∏∑‡∏≠ '‡∏ó‡πà‡∏≤‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏£‡πå' ‡∏ï‡∏≠‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á '{topic}' ‡πÅ‡∏ö‡∏ö‡πÉ‡∏´‡πâ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏à ‡∏ô‡πà‡∏≤‡∏£‡∏±‡∏Å"]).text
        res_ariel = _safe_generate_content([f"‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ Ariel AI (‡πÄ‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏•) ‡∏´‡∏ç‡∏¥‡∏á‡∏™‡∏≤‡∏ß‡πÄ‡∏¢‡πá‡∏ô‡∏ä‡∏≤ ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏π‡πà‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡∏ß‡πà‡∏≤ '‡πÄ‡∏î‡∏µ‡∏¢‡∏£‡πå' ‡∏ï‡∏≠‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á '{topic}' ‡πÅ‡∏ö‡∏ö‡∏Ç‡∏ß‡∏≤‡∏ô‡∏ú‡πà‡∏≤‡∏ã‡∏≤‡∏Å ‡∏õ‡∏£‡∏∞‡∏ä‡∏î‡∏ô‡∏¥‡∏î‡πÜ"]).text
        return res_myla, res_ariel
    except Exception as e: return f"Error: {e}", f"Error: {e}"

# 5. Crypto God Mode V2 (Senior Crypto Hedge Fund Manager - Risk-Averse)
def analyze_crypto_god_mode(coin_name, current_price, indicators, news_text, fear_greed):
    if not is_ready: return "‚ö†Ô∏è ‡∏£‡∏∞‡∏ö‡∏ö AI ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏° (‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà API Key)"
    
    # ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤ Indicators ‡πÉ‡∏´‡∏°‡πà (V2)
    rsi = float(indicators.get('rsi', 50))
    stoch_k = float(indicators.get('stoch_k', 50))  # NEW
    obv_status = str(indicators.get('obv_slope', 'N/A'))  # NEW
    
    macd = float(indicators.get('macd', 0))
    macd_signal = float(indicators.get('macd_signal', 0))
    adx = float(indicators.get('adx', 20))
    atr = float(indicators.get('atr', 0))
    
    pivot_p = float(indicators.get('pivot_p', 0))  # NEW
    pivot_s1 = float(indicators.get('pivot_s1', 0))  # NEW
    pivot_r1 = float(indicators.get('pivot_r1', 0))  # NEW
    
    support = float(indicators.get('support', current_price * 0.95))
    resistance = float(indicators.get('resistance', current_price * 1.05))
    
    # --- [V2] ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏Å‡∏±‡∏ö‡∏î‡∏±‡∏Å (Trap Detection) ---
    bearish_divergence = False
    trap_warning = ""
    if "‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏´‡∏•‡∏≠‡∏≠‡∏Å" in obv_status and rsi > 60:
        bearish_divergence = True
        trap_warning = "‚ö†Ô∏è **‡∏£‡∏∞‡∏ß‡∏±‡∏á! Bearish Divergence**: ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô‡πÅ‡∏ï‡πà‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏Å (Fake Pump) - ‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡πâ‡∏≠‡∏°‡∏™‡∏π‡∏á"
    elif adx < 20 and rsi > 70:
        trap_warning = "‚ö†Ô∏è **‡∏ï‡∏•‡∏≤‡∏î‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≤‡∏á (Sideways) + RSI Overbought**: ‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏ï‡∏±‡∏î Loss"
    
    # [THAI PROMPT UPDATE V2.0] - Risk Manager + Trap Detector
    prompt = f"""
    Role: ‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ "Senior Crypto Hedge Fund Manager" ‡∏ó‡∏µ‡πà‡πÄ‡∏ô‡πâ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏Ç‡∏≠‡∏á‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏∏‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î (Risk-First Approach)
    Task: ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç {coin_name} ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡∏£‡∏î‡∏£‡∏∞‡∏¢‡∏∞‡∏™‡∏±‡πâ‡∏ô (72 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á) ‡∏î‡πâ‡∏ß‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Quant ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
    Strategy: ‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á FOMO, ‡∏à‡∏±‡∏ö Pivot Points ‡∏ó‡∏µ‡πà‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥, ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Å‡∏±‡∏ö‡∏î‡∏±‡∏Å‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤
    
    [LIVE MARKET DATA - THB]
    Price: {current_price:,.2f} THB
    
    [MOMENTUM & TREND]
    - RSI (14): {rsi:.2f} (‡∏õ‡∏Å‡∏ï‡∏¥ >70 Overbought, <30 Oversold)
    - StochRSI (K): {stoch_k:.2f} (‡πÑ‡∏ß‡∏°‡∏≤‡∏Å: >80 ‡∏Ç‡∏≤‡∏¢, <20 ‡∏ã‡∏∑‡πâ‡∏≠) **[NEW V2]**
    - MACD vs Signal: {macd:.2f} / {macd_signal:.2f}
    - ADX Trend Strength: {adx:.2f} (‡∏ñ‡πâ‡∏≤ < 20 ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤‡∏ï‡∏•‡∏≤‡∏î Sideway ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏ä‡πâ MACD)
    
    [MONEY FLOW - ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç! **[NEW V2]**]
    - OBV Flow (5-Day): {obv_status} (‡∏ñ‡πâ‡∏≤‡∏Ñ‡πà‡∏≤‡∏ï‡∏¥‡∏î‡∏•‡∏ö ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏´‡∏•‡∏≠‡∏≠‡∏Å ‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏Å‡∏±‡∏ö‡∏î‡∏±‡∏Å‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô‡∏´‡∏•‡∏≠‡∏Å‡πÜ)
    
    [KEY LEVELS - Pivot Points **[NEW V2]**]
    - Pivot Point (Central): {pivot_p:,.2f} THB
    - Support S1 (Buy Zone): {pivot_s1:,.2f} THB
    - Resistance R1 (Sell Zone): {pivot_r1:,.2f} THB
    - ATR (‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏±‡∏ô‡∏ú‡∏ß‡∏ô): {atr:,.2f} THB
    
    [MARKET SENTIMENT]
    - Fear & Greed: {fear_greed['value']} ({fear_greed['value_classification']})
    - News: {news_text}
    
    [‚ö†Ô∏è TRAP ALERT]
    {trap_warning if trap_warning else "‚úÖ ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏±‡∏ö‡∏î‡∏±‡∏Å‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô"}
    
    [‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå - STRICT RISK MANAGEMENT]
    
    1. **‡πÄ‡∏ä‡πá‡∏Ñ‡∏Å‡∏±‡∏ö‡∏î‡∏±‡∏Å (Trap Check) [CRITICAL]:** 
       - ‡∏ñ‡πâ‡∏≤‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô‡πÅ‡∏ï‡πà OBV ‡πÑ‡∏´‡∏•‡∏≠‡∏≠‡∏Å ‡∏´‡∏£‡∏∑‡∏≠ RSI ‡∏Ç‡∏±‡∏î‡πÅ‡∏¢‡πâ‡∏á ‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô "Bearish Divergence" ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
       - ‡∏ñ‡πâ‡∏≤ ADX < 25 ‡πÉ‡∏´‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠ StochRSI ‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ MACD (‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏ï‡∏•‡∏≤‡∏î‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≤‡∏á)
    
    2. **‡∏Å‡∏£‡∏≠‡∏á‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì (Signal Filtering):**
       - ‡∏ñ‡πâ‡∏≤ ADX < 25 = Sideways Market ‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏ó‡∏£‡∏î‡∏ï‡∏≤‡∏°‡πÄ‡∏ó‡∏£‡∏ô‡∏î‡πå MACD ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ Support/Resistance ‡πÅ‡∏ó‡∏ô
       - ‡∏ñ‡πâ‡∏≤ StochRSI > 80 = ‡∏Ç‡∏≤‡∏¢ (‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤ RSI ‡∏à‡∏∞‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà)
       - ‡∏ñ‡πâ‡∏≤ StochRSI < 20 = ‡∏ã‡∏∑‡πâ‡∏≠ (‡πÅ‡∏ï‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏≠ Pivot S1 ‡∏î‡πâ‡∏ß‡∏¢)
    
    3. **‡∏à‡∏∏‡∏î‡πÄ‡∏Ç‡πâ‡∏≤‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢:**
       - ‡∏´‡πâ‡∏≤‡∏°‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡πÑ‡∏•‡πà‡∏£‡∏≤‡∏Ñ‡∏≤ (FOMO) 
       - ‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏ó‡∏µ‡πà Pivot S1: {pivot_s1:,.2f} THB ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏ô‡∏ß‡∏£‡∏±‡∏ö‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
       - Entry ‡∏ó‡∏µ‡πà‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î = Pivot S1 + ‡πÄ‡∏°‡∏∑‡πà‡∏≠ OBV ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÑ‡∏´‡∏•‡πÄ‡∏Ç‡πâ‡∏≤
    
    4. **‡∏à‡∏∏‡∏î‡∏Ç‡∏≤‡∏¢‡∏ó‡∏≥‡∏Å‡∏≥‡πÑ‡∏£‡∏ó‡∏µ‡πà‡∏ä‡∏≤‡∏ç‡∏â‡∏•‡∏≤‡∏î:**
       - Target 1: Pivot P (‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á): {pivot_p:,.2f} THB (‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏™‡∏±‡∏Å 50%)
       - Target 2: Pivot R1 (‡πÅ‡∏ô‡∏ß‡∏ï‡πâ‡∏≤‡∏ô): {pivot_r1:,.2f} THB (‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á ‡πÅ‡∏ï‡πà‡∏Å‡∏≥‡πÑ‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°)
    
    [‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö - MARKDOWN ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ (God Mode V2.0)]
    
    ## üß† QUANT GOD MODE V2.0: {coin_name}
    **‡πÄ‡∏ß‡∏•‡∏≤‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå:** {datetime.datetime.now().strftime('%d/%m/%Y %H:%M')} | **Risk Level: Manager Mode** 
    
    ### üö¶ 1Ô∏è‚É£ ‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì (Signal Status)
    * **‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô:** [‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: üü¢ BULLISH / üü° NEUTRAL / üî¥ BEARISH]
    * **‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡πà‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏ñ‡∏∑‡∏≠:** .../5 ‚≠ê (‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡∏à‡∏≤‡∏Å OBV + ADX + StochRSI)
    * **‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á:** {trap_warning if trap_warning else "(‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏™‡∏π‡∏á)"}
    
    ### ‚öñÔ∏è 2Ô∏è‚É£ ‡∏Å‡∏•‡∏¢‡∏∏‡∏ó‡∏ò‡πå 72 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á (Tactical Plan)
    
    **‡∏à‡∏∏‡∏î‡πÄ‡∏Ç‡πâ‡∏≤‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î (Best Entry):**
    * ‡∏ø{pivot_s1:,.2f} (Pivot S1 - ‡∏ä‡πâ‡∏≠‡∏ô‡∏ã‡∏∑‡πâ‡∏≠) ‚Üê **‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢**
    * ‡∏à‡∏∏‡∏î‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≥‡∏£‡∏≠‡∏á: ‡∏ø{pivot_p:,.2f} (Pivot P - ‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á)
    
    **‡πÄ‡∏õ‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏ó‡∏≥‡∏Å‡∏≥‡πÑ‡∏£ (Profit Targets):**
    * Target 1Ô∏è‚É£ (50%): ‡∏ø{pivot_p:,.2f} (Pivot Point - ‡∏ï‡∏±‡∏î‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏∂‡πà‡∏á)
    * Target 2Ô∏è‚É£ (50%): ‡∏ø{pivot_r1:,.2f} (Pivot R1 - ‡πÅ‡∏ô‡∏ß‡∏ï‡πâ‡∏≤‡∏ô ‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏°‡∏≤‡∏Å‡πÄ‡∏Å‡πá‡∏ö‡∏Å‡∏≥‡πÑ‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)
    
    **‡∏à‡∏∏‡∏î‡∏¢‡∏≠‡∏°‡πÅ‡∏û‡πâ (Stop Loss - ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç!):**
    * ‡∏ø{pivot_s1 - (atr * 1.5):,.2f} (‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≤‡∏Å S1 - 1.5√óATR)
    * **‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏≠‡∏≤‡πÑ‡∏õ‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô ‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏ç‡πÄ‡∏™‡∏µ‡∏¢**
    
    ### üé≤ 3Ô∏è‚É£ ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô 72 ‡∏ä‡∏°. (Probability Scenarios)
    * üìà **‡∏Ç‡∏∂‡πâ‡∏ô‡∏ó‡∏î‡∏™‡∏≠‡∏ö {pivot_r1:,.0f}:** ...% (‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≤‡∏Å ADX, RSI, StochRSI)
    * ü¶Ä **‡πÅ‡∏Å‡∏ß‡πà‡∏á‡∏ï‡∏±‡∏ß‡πÉ‡∏ô‡∏Å‡∏£‡∏≠‡∏ö ({pivot_s1:,.0f}-{pivot_r1:,.0f}):** ...%
    * üìâ **‡∏ó‡∏∏‡∏ö‡∏´‡∏•‡∏∏‡∏î‡πÅ‡∏ô‡∏ß‡∏£‡∏±‡∏ö {pivot_s1:,.0f}:** ...%
    
    ### üí° 4Ô∏è‚É£ ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÄ‡∏ä‡∏¥‡∏á‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ (Deep Dive Analysis)
    
    **Trend & Momentum:**
    * ADX = {adx:.1f} ‚Üí {'‡πÄ‡∏ó‡∏£‡∏ô‡∏î‡πå‡πÅ‡∏Ç‡πá‡∏á‡πÅ‡∏Å‡∏£‡πà‡∏á ‡πÉ‡∏ä‡πâ MACD ‡πÑ‡∏î‡πâ' if adx > 25 else '‡πÑ‡∏£‡πâ‡πÄ‡∏ó‡∏£‡∏ô‡∏î‡πå ‡∏ï‡∏•‡∏≤‡∏î Sideways ‡∏´‡πâ‡∏≤‡∏°‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏° Trend'}
    * RSI = {rsi:.1f} ‚Üí {'‚ö†Ô∏è Overbought (‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ú‡∏•‡∏±‡∏î‡∏ï‡∏±‡∏ß)' if rsi > 70 else '‚ö†Ô∏è Oversold (‡πÄ‡∏Å‡πá‡∏ö‡∏ï‡∏±‡∏ß ‡∏£‡∏≠‡πÄ‡∏î‡πâ‡∏á)' if rsi < 30 else '‚úÖ Neutral (‡∏õ‡∏Å‡∏ï‡∏¥)'}
    * StochRSI = {stoch_k:.1f} ‚Üí {'‚ö° ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏Ç‡∏≤‡∏¢‡πÅ‡∏Ç‡πá‡∏á' if stoch_k > 80 else '‚ö° ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏ã‡∏∑‡πâ‡∏≠‡πÅ‡∏Ç‡πá‡∏á' if stoch_k < 20 else '‚û°Ô∏è Ranging'}
    * MACD = {'‚úÖ ‡∏ï‡∏±‡∏î‡∏Ç‡∏∂‡πâ‡∏ô (Bullish)' if macd > macd_signal else '‚ùå ‡∏ï‡∏±‡∏î‡∏•‡∏á (Bearish)'}
    
    **Smart Money Flow (‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î!):**
    * OBV Slope: {obv_status}
    * {'üü¢ ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏ï‡πá‡∏°‡πÑ‡∏õ‡∏´‡∏°‡∏î = ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏ã‡∏∑‡πâ‡∏≠‡πÅ‡∏Ç‡πá‡∏á' if '‡πÄ‡∏Ç‡πâ‡∏≤' in obv_status else 'üî¥ ‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡∏ô‡∏¥‡πà‡∏°‡∏ô‡∏ß‡∏• = ‡∏£‡∏∞‡∏ß‡∏±‡∏á Fake Pump'}
    * **‡∏™‡∏£‡∏∏‡∏õ:** {'‡∏ï‡∏±‡∏ß‡∏à‡∏£‡∏¥‡∏á Bullish' if '‡πÄ‡∏Ç‡πâ‡∏≤' in obv_status else '‡∏Å‡∏±‡∏ö‡∏î‡∏±‡∏Å‡∏£‡∏≤‡∏Ñ‡∏≤ (Trap)'}
    
    ### üìã 5Ô∏è‚É£ ‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡∏£‡∏î (Trading Summary)
    
    | ‡∏õ‡∏±‡∏à‡∏à‡∏±‡∏¢ | ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• |
    | :--- | :--- |
    | **Entry Zone** | ‡∏ø{pivot_s1:,.2f} (Pivot S1) |
    | **Target 1** | ‡∏ø{pivot_p:,.2f} (Pivot P - 50%) |
    | **Target 2** | ‡∏ø{pivot_r1:,.2f} (Pivot R1 - 100%) |
    | **Stop Loss** | ‡∏ø{pivot_s1 - (atr * 1.5):,.2f} (S1 - 1.5√óATR) |
    | **Risk:Reward** | 1:... (‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏≠‡∏á) |
    | **Signal Strength** | {'üü¢üü¢üü¢ Very Strong' if adx > 35 and '‡πÄ‡∏Ç‡πâ‡∏≤' in obv_status else 'üü°üü° Moderate' if adx > 20 else 'üî¥ Weak'} |
    
    ---
    *üõ°Ô∏è ‡∏ö‡∏ó‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ô‡∏µ‡πâ‡πÄ‡∏ô‡πâ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡πÅ‡∏•‡∏∞‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á FOMO ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å (Risk Manager Mode)*
    *‚ö†Ô∏è ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∏‡∏ô (NFA) | ‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô*
    """
    
    try:
        res = _safe_generate_content([prompt])
        return res.text
    except Exception as e:
        return f"Quant System Error: {e}"